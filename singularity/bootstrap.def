Bootstrap: docker
From: feelpp/feelpp-toolboxes:latest

%labels
Maintainer guillaume.dolle@cemosis.fr
Version 1.0

%files
    singularity.d/env/99-feelenv.sh .singularity.d/env/

%setup
    echo "Looking in directory '$SINGULARITY_ROOTFS' for /bin/sh"
    if [ ! -x "$SINGULARITY_ROOTFS/bin/sh" ]; then
        echo "Hrmm, this container does not have /bin/sh installed..."
        exit 1
    fi
    exit 0

%post
    echo "Post install"
    sed -i 's/.*PS1 *=.*//g' /etc/bash.bashrc
    sed -i 's/.*PS1 *=.*//g' /.singularity.d/actions/shell
    sed -i 's/.*PS1 *=.*//g' /.singularity.d/env/99-base.sh
    sed -i 's/.*HOME *=.*//g' /.singularity.d/env/10-docker.sh
    mkdir /feel
    mv /home/feelpp /opt/feelpp
    userdel feelpp
    chown -R root:root /opt/feelpp
    chmod -R 777 /opt/feelpp
    
    # Clean temporary files. 
    rm -rf `find /opt/feelpp -name ".*" ! -path .`

    echo "alias ls='ls --color=auto'" >> /etc/bash.bashrc
    echo "alias ll='ls -ls'" >> /etc/bash.bashrc
    echo "alias grep='grep --color'" >> /etc/bash.bashrc

    PACKAGES="dapl2-utils libdapl-dev libdapl2 libibverbs1 librdmacm1 libcxgb3-1 libipathverbs1 libmlx4-1 libmlx5-1 libmthca1 libnes1 libpmi0 libpmi0-dev"
    apt-get update
    apt-get -y --allow-unauthenticated install $PACKAGES

    exit 0

%runscript
    echo "Arguments received: $*"
    exec /usr/bin/python "$@"

%environment
white=`tput setaf 7`
cyan=`tput setaf 6`
reset=`tput sgr0`
bold=`tput bold`
escleft="\[" # `if [ "${SHELL##*/}" == "bash" ]; then echo '\['; fi`
escright="\]" #`if [ "${SHELL##*/}" == "bash" ]; then echo '\]'; fi`
USER=`id -un`
HOSTNAME=`hostname`

export SINGULARITY_SHELL=bash
export FEELPP_TUTORIAL=/opt/feelpp
export PS1="${escleft}${bold}${white}${escright}[singularity]:${escleft}${cyan}${escright} ${USER}@${HOSTNAME}${escleft}${reset}${escright}:\w> "

