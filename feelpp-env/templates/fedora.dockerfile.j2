FROM {{ base_image }}
LABEL maintainer="Feel++ Support <support@feelpp.org>"

# Distribution: {{ dist_name }} {{ dist_version }}
# Variant: {{ variant_name }}

# BuildKit auto platform args
ARG TARGETPLATFORM
ARG TARGETARCH
ARG TARGETOS

# Useful env defaults
ENV FEELPP_DEP_INSTALL_PREFIX=/usr/local \
    DNF_YUM_BACKEND=dnf5

# Use bash -l for subsequent RUNs
SHELL ["/bin/bash", "-l", "-c"]

# Install all packages
RUN set -eux; \
    dnf -y update; \
    dnf -y install \
{{ packages | join_packages(8) }}
      --setopt=install_weak_deps=False \
      --best --allowerasing; \
    dnf -y install redhat-lsb-core || dnf -y install redhat-lsb || true; \
    dnf clean all; \
    rm -rf /var/cache/dnf

{% if enable_openmpi %}
# OpenMPI Configuration
ENV OMPI_MCA_pml=ob1 \
    OMPI_MCA_btl=self,vader \
    OMPI_MCA_mtl=^ofi,psm2 \
    OMPI_MCA_btl_vader_single_copy_mechanism=cma

# Allow MPI as root
ENV OMPI_ALLOW_RUN_AS_ROOT=1 \
    OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1

# Make OpenMPI globally visible
ENV PATH="/usr/lib64/openmpi/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:${LD_LIBRARY_PATH}"

# Shell environment helper
RUN set -eux; \
  cat >/etc/profile.d/00-feelpp-env.sh <<'EOF'
# Feel++ base environment

# Source environment-modules if present
if [ -f /etc/profile.d/modules.sh ]; then
  . /etc/profile.d/modules.sh
elif [ -f /usr/share/Modules/init/bash ]; then
  . /usr/share/Modules/init/bash
fi

# Load OpenMPI module
if type module >/dev/null 2>&1; then
  module load mpi/openmpi-x86_64 2>/dev/null || true
fi

# Fallback: ensure OpenMPI tools are visible
if ! command -v mpicc >/dev/null 2>&1; then
  if [ -d /usr/lib64/openmpi/bin ]; then
    export PATH="/usr/lib64/openmpi/bin:${PATH}"
  fi
  if [ -d /usr/lib64/openmpi/lib ]; then
    export LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:${LD_LIBRARY_PATH:-}"
  fi
fi
EOF

{% endif %}

# Keep PATH nice
ENV PATH=/usr/local/bin:${PATH}
