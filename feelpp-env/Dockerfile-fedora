# --- BuildKit auto platform args (injected by buildx) ---
ARG TARGETPLATFORM
ARG TARGETARCH
ARG TARGETOS

# --- Useful env defaults (baked per-arch) ---
ENV FEELPP_DEP_INSTALL_PREFIX=/usr/local \
    DNF_YUM_BACKEND=dnf5

# -------- System setup --------
# Use bash -l for subsequent RUNs so /etc/profile.d gets sourced when needed
SHELL ["/bin/bash", "-l", "-c"]

RUN set -eux; \
    dnf -y update; \
    dnf -y install \
      sudo which tree ninja-build \
      clang cmake git ruby jq curl \
      environment-modules openmpi openmpi-devel \
      python3 python3-devel python3-pip python3-virtualenv python3-sympy \
      python3-mpi4py-openmpi \
      boost-devel boost-openmpi-devel \
      MUMPS-openmpi-devel metis-devel \
      petsc-devel petsc-openmpi-devel python3-petsc-openmpi \
      gmsh gmsh-devel hdf5-openmpi-devel libzip-devel pugixml-devel \
      libcurl-devel cln-devel \
      openssl-devel libffi-devel \
      lsof procps-ng findutils file \
      nodejs \
      --setopt=install_weak_deps=False \
      --best --allowerasing; \
    dnf -y install redhat-lsb-core || dnf -y install redhat-lsb || true; \
    dnf clean all; \
    rm -rf /var/cache/dnf

# ----------------------------------------------------------------------------------
# Open MPI Configuration
#
# The following environment variables configure how Open MPI operates within the container:
#
# 1. OMPI_MCA_pml:
#    - Defines the point-to-point messaging layer.
#    - Setting to "ob1" selects the basic, yet versatile, messaging layer.
#
# 2. OMPI_MCA_btl:
#    - Specifies the Byte Transfer Layers (BTLs) for data movement.
#    - "self,vader" enables both the self and vader BTLs. The "self" BTL handles
#      loopback communication while "vader" is optimized for intranode communication.
#
# 3. OMPI_MCA_mtl:
#    - Controls the Message Transfer Layers (MTLs).
#    - The value "^ofi,psm2" disables the "ofi" and "psm2" modules to avoid conflicts
#      and potentially enforce the use of the selected PML/BTL configuration.
#
# 4. OMPI_MCA_btl_vader_single_copy_mechanism:
#    - Determines the mechanism used by the vader BTL for single-copy operations.
#    - The "cma" value enforces the use of Cross Memory Attach (CMA) for efficient memory copying.
#
# These settings are chosen to optimize performance and ensure compatibility
# within the containerized environment based on Fedora.
# ----------------------------------------------------------------------------------
ENV OMPI_MCA_pml=ob1 \
    OMPI_MCA_btl=self,vader \
    OMPI_MCA_mtl=^ofi,psm2 \
    OMPI_MCA_btl_vader_single_copy_mechanism=cma

# allow mpi as root
ENV OMPI_ALLOW_RUN_AS_ROOT=1 \
    OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1

# --- Make OpenMPI globally visible in ALL contexts (non-interactive builds, CI, etc.)
ENV PATH="/usr/lib64/openmpi/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:${LD_LIBRARY_PATH}"

# -------- Shell environment helper: /etc/profile.d --------
# - Source environment-modules if present
# - Load OpenMPI module whenever 'module' exists (not only interactive shells)
# - Leave PATH/LD_LIBRARY_PATH as-is (already set above); keep fallback just in case
RUN set -eux; \
  cat >/etc/profile.d/00-feelpp-env.sh <<'EOF'
# Feel++ base environment

# Source environment-modules (Modules or Lmod) if present
if [ -f /etc/profile.d/modules.sh ]; then
  . /etc/profile.d/modules.sh
elif [ -f /usr/share/Modules/init/bash ]; then
  . /usr/share/Modules/init/bash
fi

# Load OpenMPI module whenever modules are available (non-fatal)
if type module >/dev/null 2>&1; then
  module load mpi/openmpi-x86_64 2>/dev/null || true
fi

# Fallback: ensure OpenMPI tools are visible even if modules weren't sourced
if ! command -v mpicc >/dev/null 2>&1; then
  if [ -d /usr/lib64/openmpi/bin ]; then
    export PATH="/usr/lib64/openmpi/bin:${PATH}"
  fi
  if [ -d /usr/lib64/openmpi/lib ]; then
    export LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:${LD_LIBRARY_PATH:-}"
  fi
fi
EOF

# -------- Optional: enable environment-modules in interactive bash --------
RUN set -eux; \
  if ! grep -q '/etc/profile.d/modules.sh' /etc/bashrc 2>/dev/null; then \
    printf '\n# Enable environment-modules for interactive bash\n' >> /etc/bashrc; \
    printf '[ -f /etc/profile.d/modules.sh ] && . /etc/profile.d/modules.sh || true\n' >> /etc/bashrc; \
  fi

# -------- Quick sanity checks (non-fatal) --------
RUN set -eux; \
    echo; echo "=== OpenMPI sanity (non-fatal) ==="; \
    command -v mpicc  && mpicc  --version  | head -n1 || true; \
    command -v mpirun && mpirun --version | head -n1 || true; \
    type module >/dev/null 2>&1 && module avail 2>/dev/null | head -n20 || true; \
    echo "==================================="; echo

# Keep PATH nice
ENV PATH=/usr/local/bin:${PATH}