name: Feel++ Env

on: 
  push: 
    paths:
      - 'feelpp-env/**'
      - '.github/workflows/feelpp-env.yml'
  workflow_dispatch:
    inputs:
      dist:
        description: 'Distribution codename'     
        required: true
        default: 'jammy'
      flavor:
        description: 'Flavor of the distribution'  
        required: true
        default: ubuntu
      version:
        description: 'Version of the distribution'  
        required: true
        default: 22.04
      dockerfile:
        description: 'Dockerfile to use'  
        required: false
        default: Dockerfile



jobs:

  activate:
    runs-on: self-docker
    if: |
      github.repository == 'feelpp/docker' &&
      !startsWith(github.event.head_commit.message, 'Release ') &&
      !contains(github.event.head_commit.message, 'ci skip')
    steps:
    - run: echo ok go


  all_images:
    if: ${{ github.event_name == 'push' }} && "!contains(github.event.head_commit.message, 'all skip')" 
    strategy:
      fail-fast: false
      matrix: 
        include:
          - {service: feelpp-env, dist: focal, flavor: ubuntu, version: "20.04", tag: ubuntu-20.04, dockerfile: Dockerfile }
          - {service: feelpp-env, dist: kinetic, flavor: ubuntu, version: "22.10", tag: ubuntu-22.10, dockerfile: Dockerfile }
          - {service: feelpp-env, dist: jammy, flavor: ubuntu, version: "22.04", tag: ubuntu-22.04, dockerfile: Dockerfile }
#          - {service: feelpp-env, dist: buster, flavor: debian, version: 10, tag: debian-10, dockerfile: Dockerfile }
          - {service: feelpp-env, dist: bullseye, flavor: debian, version: "11", tag: debian-11, dockerfile: Dockerfile }
#          - {service: feelpp-env, dist: bookworm, flavor: debian, version: "12", tag: debian-bookworm, dockerfile: Dockerfile }
          - {service: feelpp-env, dist: fedora-36, flavor: fedora, version: "36", tag: fedora-36, dockerfile: Dockerfile }
#          - {service: feelpp-env, dist: fedora-37, flavor: fedora, version: 37, tag: fedora-37, dockerfile: Dockerfile }
    runs-on: self-docker
    needs: activate
    name: ${{ matrix.dist }}

    steps:
    - uses: actions/checkout@v2.3.4
      with:
#        lfs: true  
        token: ${{ secrets.CR_PAT }}
        submodules: recursive
    - name: generate
      run: |
        bash mkimg.sh  -f ${{ matrix.flavor }}:${{ matrix.version }} -t feelpp/${{ matrix.service }}:${{ matrix.tag }}  --
        echo "::set-output name=context::feelpp-env/$(bash mkimg.sh  -f ${{ matrix.flavor }}:${{ matrix.version }} -t feelpp/${{ matrix.service }}:${{ matrix.tag }}  --)"
        ls -lrt
      id: generate
      working-directory: feelpp-env
    -
      name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    -
      name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1        
    - 
      name: Login to GitHub Container Registry
      uses: docker/login-action@v1 
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.CR_PAT }}
    - 
      name: Build ${{ matrix.service }}:${{ matrix.tag }}
      uses: docker/build-push-action@v2
      with: 
        context: ./${{ steps.generate.outputs.context }}
        tags: ghcr.io/feelpp/${{ matrix.service }}:${{ matrix.tag }}
        file: ./${{ steps.generate.outputs.context }}/${{ matrix.dockerfile }}
        push: ${{ github.event_name != 'pull_request' }}


  one_images:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: self-docker
    needs: activate
    name: ${{ inputs.dist }}
    env:
      tag: ${{ inputs.flavor }}-${{ inputs.version }}
    steps:
    - uses: actions/checkout@v2.3.4
      with:
#        lfs: true  
        token: ${{ secrets.CR_PAT }}
        submodules: recursive
    - name: generate
      run: |
        bash mkimg.sh  -f ${{ inputs.flavor }}:${{ inputs.version }} -t feelpp/${{ inputs.service }}:${{ tag }}  --
        echo "::set-output name=context::feelpp-env/$(bash mkimg.sh  -f ${{ inputs.flavor }}:${{ inputs.version }} -t feelpp/${{ inputs.service }}:${{ tag }}  --)"
        ls -lrt
      id: generate
      working-directory: feelpp-env
    -
      name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    -
      name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1        
    - 
      name: Login to GitHub Container Registry
      uses: docker/login-action@v1 
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.CR_PAT }}
    - 
      name: Build ${{ inputs.service }}:${{ tag }}
      uses: docker/build-push-action@v2
      with: 
        context: ./${{ steps.generate.outputs.context }}
        tags: ghcr.io/feelpp/${{ inputs.service }}:${{ tag }}
        file: ./${{ steps.generate.outputs.context }}/${{ inputs.dockerfile }}
        push: ${{ github.event_name != 'pull_request' }}
